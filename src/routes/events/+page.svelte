<script lang="ts">
	import { onMount } from 'svelte';

	let events: any;

	async function handleFetchEvents() {
		try {
			let request = new XMLHttpRequest();
			request.open('GET', 'https://corsproxy.io//?https://leboeuflasing.ddns.net/uaEvents.json');
			request.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					events = JSON.parse(this.response);
				} else {
					console.log('Connection Loading...');
				}
			};
			request.send();
		} catch (error) {
			alert(error);
		}
	}

	async function DisplayCalender() {
		let calender = document.getElementsByClassName('calenderContent')[0];

		calender.innerHTML = '<p> Loading Calender information... </p>';

		let i = 0;
		while (events == null && i < 10) {
			await new Promise((r) => setTimeout(r, 500));
			i++;
		} // Wait for events to be loaded

		if (events == null) {
			//timeout error
			calender.innerHTML =
				'<div class="eventCard"><p>There was an error loading the events. Please try again later.</p><br><a href="/events"><button onClick="window.location.reload();">Refresh</button></a></div>';
		} else if (events.length == 0) {
			//no events
			calender.innerHTML =
				'<div class="eventCard"><p>There are no upcoming events at this time.</p></div>';
		} else {
			//display events
			calender.innerHTML = ''; //clear loading message

			for (let i = 0; i < events.length; i++) {
				let event = events[i];

				//calender-content div
				//  event-card div
				//    event-text div
				//    event-img-div div
				//  event-card div
				//    event-text div
				//    event-img-div div

				let eventDiv = document.createElement('div');
				eventDiv.classList.add('eventCard');

				let textDiv = document.createElement('div');
				textDiv.classList.add('eventText');

				let eventTitle = document.createElement('h2');
				eventTitle.innerText = event.event_name;
				let bar = document.createElement('hr');
				bar.classList.add('bar');
				let eventDate = document.createElement('p');
				let date = new Date(parseInt(event.event_date) * 1000);
				eventDate.innerText = date.toDateString() + ' ' + date.toLocaleTimeString();
				let eventLocation = document.createElement('p');
				eventLocation.innerText = event.event_location;
				let eventDescription = document.createElement('p');
				eventDescription.innerText = event.event_description;
				let eventAttendanceRequired = document.createElement('p');
				let bar2 = document.createElement('hr');
				bar2.classList.add('bar');
				if (event.event_required === '0') {
					eventAttendanceRequired.innerHTML =
						'<sub>This event is not required for members to attend.*</sub>';
				} else {
					eventAttendanceRequired.innerHTML =
						'<sub><b>This event is required for members to attend.*</b></sub>';
				}
				textDiv.appendChild(eventTitle);
				textDiv.appendChild(bar);
				textDiv.appendChild(eventDate);
				textDiv.appendChild(eventLocation);
				textDiv.appendChild(eventDescription);
				textDiv.appendChild(bar2);
				textDiv.appendChild(eventAttendanceRequired);

				let imgDiv = document.createElement('div');
				imgDiv.classList.add('eventImgDiv');
				let eventImg = document.createElement('img');
				if (event.event_image_url === '') {
					eventImg.src = '/src/lib/images/Logo.png';
				} else {
					eventImg.src = event.event_image_url;
				}
				eventImg.alt = event.event_name + ' Thumbnail';
				eventImg.classList.add('eventImg');
				imgDiv.appendChild(eventImg);

				eventDiv.appendChild(textDiv);
				eventDiv.appendChild(imgDiv);

				calender.appendChild(eventDiv);
			}

			let attendanceFootnote = document.createElement('p');
			attendanceFootnote.innerHTML =
				'<sub>*Autogenerated from the attendance system. May be inaccurate.</sub>';
			attendanceFootnote.classList.add('attendanceFootnote');
			calender.appendChild(attendanceFootnote);
		}

		//add css (must be done after events are loaded otherwise css doesn't apply)
		let cssDiv = document.getElementsByClassName('cssDiv')[0];
		let cssLink = document.createElement('link');
		cssLink.rel = 'stylesheet';
		cssLink.href = '/src/routes/events/style.css';
		cssDiv.appendChild(cssLink);
	}

	onMount(() => {
		handleFetchEvents();
		DisplayCalender();
	});
</script>

<svelte:head>
	<title>Current Events</title>
	<meta name="description" content="The current events happening for UA Robotics." />
</svelte:head>

<div class="text-column">
	<h1>Upcoming Events</h1>
	<p>
		Here is an live-updated calender of events University of Akron RMC will be attending. Join us
		and meet the team!
	</p>
	<div class="calenderContent" />
	<div class="cssDiv" />
</div>
